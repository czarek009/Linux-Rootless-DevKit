FROM debian:12 AS tester

LABEL maintainer="Michal Kukowski <kukossw@gmail.com>"

ENV DEBIAN_FRONTEND=noninteractive

# The CI on github actions is unstable (flaky).
# Sometimes, the package manager cannot connect to the repository.
# We need to retry the update and install commands a few times to avoid the failure.
RUN printf 'Acquire {\n  Retries \"10\";\n};\n' > /etc/apt/apt.conf.d/99retry

# =============== Install common packages (fonts, bash, locales ...) ===============

# Packages are installed on most distributions, in case of real images (real HW, VM, VDI).
# Usually, user would not have to install them manually.
# This is a base image for testing, so we install them here.

USER root

RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
        bash \
        coreutils \
        fontconfig \
        locales && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ==================================================================================

# ================= Make fundamental configuration (language ...) ==================

# The confifuration usually is done by the user during the installation of the system or first login.
# Usually, user would not have to do it manually (admin does it for him).
# This is a base image for testing, so we do it here.

USER root

ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US:en
ENV LC_ALL=en_US.UTF-8

RUN echo "en_US.UTF-8 UTF-8" > /etc/locale.gen && \
    locale-gen && \
    update-locale LANG=en_US.UTF-8

# ==================================================================================

# ================ Simulate user without root privileges (no sudo) =================

USER root

RUN groupadd -f -g 1111 tester-no-root && \
    useradd -m -u 1111 -g tester-no-root tester-no-root

RUN chgrp -R tester-no-root /tmp && \
    chmod -R g+rwx /tmp

RUN mkdir -p /home/tester-no-root/Downloads && \
    chown -R tester-no-root:tester-no-root /home/tester-no-root

# ==================================================================================

# =========================== Install required packages ============================

# To see which packages are required, see README.md in the project root directory.
# The main feature of this project is to require as few packages as possible.
# Usually, user would not have to install them manually.
# The biggers dependensies, are:
# - podman (container engine, alternative to docker, without root privileges and demon)
# - bash
# - GNU coreutils (basic commands like ls, cp, mv, rm, etc.)

USER root

RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
        podman && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# podman requires some additional configuration to work without root privileges
# Usually, user would not have to do it manually (admin does it for him).
# Moreover, without podman properly configred and available on the machine, our project would not work.
# Our target user is the one who has no root privileges, but has podman installed and configured.
# To simulate such a user, we need to create a proper podman configuration here.

# Install slirp4netns and fuse-overlayfs, which are required for podman to work without root privileges
# slirp4netns is used for user-mode networking
# fuse-overlayfs is used for user-mode storage
# uidmap is used for user namespaces (user storage)
# containernetworking-plugins is used for CNI (Container Network Interface): bridge/portmap/firewall/tuning
RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
        slirp4netns \
        fuse-overlayfs \
        uidmap \
        containernetworking-plugins && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Grant the tester-no-root user a subordinate UID/GID range
RUN usermod --add-subuids 100000-165535 --add-subgids 100000-165535 tester-no-root

# Ensure XDG_RUNTIME_DIR exists and is owned by tester-no-root
ENV XDG_RUNTIME_DIR=/run/user/1111
RUN mkdir -p ${XDG_RUNTIME_DIR} && \
    chown tester-no-root:tester-no-root ${XDG_RUNTIME_DIR}

# Add set-uid for newuidmap and newgidmap binaries
RUN chmod 4755 /usr/bin/newuidmap /usr/bin/newgidmap

# Update ca-certificates to ensure podman can access the internet and download images
RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
        ca-certificates && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    update-ca-certificates

# We need to remount the root filesystem as shared, so that podman can work properly
# This is a workaround for the issue with podman not being able to run containers without root
# privileges due to the root filesystem being mounted as private.
# The issue should not be a problem in real environments, but it is in the container.
# Remounting the root filesystem as shared should be done in the runtime, so the wrapper script is needed.

RUN echo '#!/usr/bin/env bash' > /usr/local/bin/podman_wrapper.sh && \
    echo 'sudo mount --make-rshared / 2>/dev/null || true' >> /usr/local/bin/podman_wrapper.sh && \
    echo 'exec "$@"' >> /usr/local/bin/podman_wrapper.sh && \
    chmod +x /usr/local/bin/podman_wrapper.sh

# We would like to test the project using the user wirthout root privileges,
# so we need to add only sudo access to /usr/bin/mount command

RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
        sudo && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN echo 'tester-no-root ALL=(root) NOPASSWD: /usr/bin/mount' > /etc/sudoers.d/99-tester-no-root-mount && \
    chmod 0440 /etc/sudoers.d/99-tester-no-root-mount

# ==================================================================================

# ========================= Download project (copy files) ==========================

COPY . /home/tester-no-root/Downloads
WORKDIR /home/tester-no-root/Downloads

# ==================================================================================

USER tester-no-root
ENTRYPOINT ["/usr/local/bin/podman_wrapper.sh"]
CMD ["podman", "run", "ubuntu:latest", "echo", "PASSED"]